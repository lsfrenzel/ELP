{% extends "base.html" %}

{% block title %}Relatórios - ELP Obras{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="fas fa-file-alt me-2"></i>Relatórios</h1>
        <p class="text-muted">Visualize e gerencie relatórios de obra</p>
    </div>
    <div class="col-auto">
        <a href="{{ url_for('create_report_form') }}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>Novo Relatório
        </a>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <form method="GET">
                    <div class="row g-3 align-items-end">
                        <div class="col">
                            <label for="obra_filter" class="form-label">Filtrar por Obra</label>
                            <select class="form-control" id="obra_filter" name="obra_id" onchange="this.form.submit()">
                                <option value="">Todas as obras</option>
                                {% for obra in obras %}
                                <option value="{{ obra.id }}" {% if selected_obra == obra.id|string %}selected{% endif %}>
                                    {{ obra.nome }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-auto">
                            {% if selected_obra %}
                            <a href="{{ url_for('reports') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i>Limpar
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if relatorios %}
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Obra</th>
                        <th>Data</th>
                        <th>Responsável</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for relatorio in relatorios %}
                    <tr>
                        <td>
                            <span class="fw-bold">#{{ "%03d"|format(relatorio.numero_seq) }}</span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-building text-primary me-2"></i>
                                <div>
                                    <div class="fw-medium">{{ relatorio.obra.nome }}</div>
                                    <small class="text-muted">{{ relatorio.obra.tipo }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>{{ relatorio.data.strftime('%d/%m/%Y') }}</div>
                            <small class="text-muted">{{ relatorio.data_criacao.strftime('%H:%M') }}</small>
                        </td>
                        <td>{{ relatorio.usuario.nome }}</td>
                        <td>
                            <span class="badge bg-{{ 'success' if relatorio.status == 'fechado' else 'warning' }}">
                                {{ relatorio.status.title() }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewReport({{ relatorio.id }})" title="Visualizar">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if current_user.role == 'admin' or (relatorio.status == 'aberto' and relatorio.usuario_id == current_user.id) %}
                                <button class="btn btn-outline-warning" onclick="editReport({{ relatorio.id }})" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                {% endif %}
                                <a href="{{ url_for('generate_report_pdf', report_id=relatorio.id) }}" class="btn btn-outline-success" title="Gerar PDF">
                                    <i class="fas fa-file-pdf"></i>
                                </a>
                                <button class="btn btn-outline-info" onclick="sendEmail({{ relatorio.id }})" title="Enviar por Email">
                                    <i class="fas fa-envelope"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
<div class="text-center py-5">
    <i class="fas fa-file-alt fa-4x text-muted mb-3"></i>
    <h3 class="text-muted">Nenhum relatório encontrado</h3>
    <p class="text-muted">{% if selected_obra %}Nenhum relatório encontrado para a obra selecionada{% else %}Comece criando seu primeiro relatório{% endif %}</p>
    <a href="{{ url_for('create_report_form') }}" class="btn btn-primary">
        <i class="fas fa-plus me-1"></i>Criar Primeiro Relatório
    </a>
</div>
{% endif %}

<!-- Report View Modal -->
<div class="modal fade" id="reportViewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Relatório</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="reportDetails">
                <!-- Report details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Email Modal -->
<div class="modal fade" id="emailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Enviar Relatório por Email</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="emailForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="emailRecipients" class="form-label">Destinatários</label>
                        <textarea class="form-control" id="emailRecipients" placeholder="email1@exemplo.com, email2@exemplo.com" rows="3" required></textarea>
                        <small class="form-text text-muted">Separe múltiplos emails com vírgula</small>
                    </div>
                    <div class="mb-3">
                        <label for="emailMessage" class="form-label">Mensagem (opcional)</label>
                        <textarea class="form-control" id="emailMessage" rows="3" placeholder="Mensagem adicional para o email"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Enviar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentReportId = null;

function viewReport(reportId) {
    // Implementation for viewing report details
    document.getElementById('reportDetails').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2">Carregando detalhes do relatório...</p>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('reportViewModal'));
    modal.show();
    
    // Simulate loading report details
    setTimeout(() => {
        document.getElementById('reportDetails').innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Informações Gerais</h6>
                    <p><strong>Relatório:</strong> #${reportId.toString().padStart(3, '0')}</p>
                    <p><strong>Status:</strong> <span class="badge bg-warning">Aberto</span></p>
                    <p><strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
                </div>
                <div class="col-md-6">
                    <h6>Localização</h6>
                    <p><strong>Coordenadas:</strong> Não informado</p>
                    <p><strong>Endereço:</strong> Conforme cadastro da obra</p>
                </div>
            </div>
            <hr>
            <h6>Atividades Realizadas</h6>
            <p class="text-muted">Detalhes das atividades seriam carregados aqui...</p>
            
            <h6>Checklist</h6>
            <p class="text-muted">Itens do checklist seriam exibidos aqui...</p>
            
            <h6>Fotos</h6>
            <p class="text-muted">Galeria de fotos seria exibida aqui...</p>
        `;
    }, 1000);
}

function editReport(reportId) {
    // Implementation for editing report
    window.location.href = `${window.location.origin}/reports/edit/${reportId}`;
}

function generatePDF(reportId) {
    // Implementation for PDF generation
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;
    
    // Simulate PDF generation
    setTimeout(() => {
        alert('PDF gerado com sucesso! O download iniciará automaticamente.');
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        
        // Simulate download
        const link = document.createElement('a');
        link.href = '#';
        link.download = `relatorio_${reportId.toString().padStart(3, '0')}.pdf`;
        link.click();
    }, 2000);
}

function sendEmail(reportId) {
    currentReportId = reportId;
    const modal = new bootstrap.Modal(document.getElementById('emailModal'));
    modal.show();
}

document.getElementById('emailForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const recipients = document.getElementById('emailRecipients').value;
    const message = document.getElementById('emailMessage').value;
    
    if (!recipients.trim()) {
        alert('Por favor, informe pelo menos um destinatário.');
        return;
    }
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enviando...';
    submitBtn.disabled = true;
    
    // Simulate email sending
    setTimeout(() => {
        alert('Email enviado com sucesso!');
        document.getElementById('emailModal').querySelector('[data-bs-dismiss="modal"]').click();
        submitBtn.innerHTML = 'Enviar';
        submitBtn.disabled = false;
        document.getElementById('emailForm').reset();
    }, 2000);
});
</script>
{% endblock %}
